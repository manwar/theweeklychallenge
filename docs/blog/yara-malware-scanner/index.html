<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
    <!-- Basic Page Needs -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title"       content="Yara Malware Scanner"/>
    <meta property="og:type"        content="website"/>
    <meta property="og:url"         content="https://theweeklychallenge.org/blog/yara-malware-scanner/"/>
    <meta property="og:image"       content="https://theweeklychallenge.org/images/about/about.jpg"/>
    <meta property="og:description" content="Discussion about Yara Malware Scanner."/>
    <meta name="twitter:card"       content="summary" />
    <meta name="twitter:image"      content="https://theweeklychallenge.org/images/about/about.jpg"/>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <meta name="description" content="Discussion about Yara Malware Scanner.">
    <meta name="author" content="The Weekly Challenge Team">
    <meta name="generator" content="Hugo 0.67.0-DEV" />

    <link rel="me" href="https://fosstodon.org/@manwar">
    <link rel="canonical" href="https://theweeklychallenge.org/blog/yara-malware-scanner/" />

    <!-- Mobile Specific Metas -->
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Yara Malware Scanner</title>
    <link rel="icon" href="https://theweeklychallenge.org/images/favicon.ico">

    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css"/>

    <!-- Twitter Bootstrs CSS -->
    <link rel="stylesheet" href="https://theweeklychallenge.org/plugins/bootstrap/bootstrap.min.css">
    <!-- Ionicons Fonts Css -->
    <link rel="stylesheet" href="https://theweeklychallenge.org/plugins/ionicons/ionicons.min.css">
    <!-- animate css -->
    <link rel="stylesheet" href="https://theweeklychallenge.org/plugins/animate-css/animate.css">
    <!-- Hero area slider css-->
    <link rel="stylesheet" href="https://theweeklychallenge.org/plugins/slider/slider.css">
    <!-- slick slider -->
    <link rel="stylesheet" href="https://theweeklychallenge.org/plugins/slick/slick.css">
    <!-- Fancybox -->
    <link rel="stylesheet" href="https://theweeklychallenge.org/plugins/facncybox/jquery.fancybox.css">
    <!-- hover -->
    <link rel="stylesheet" href="https://theweeklychallenge.org/plugins/hover/hover-min.css">
    <!-- Google fonts -->
    <link href='https://fonts.googleapis.com/css?family=Source Code Pro' rel='stylesheet'>
    <!-- template main css file -->
    
    <link rel="stylesheet" href="https://theweeklychallenge.org/css/style.min.css" integrity="" media="screen">
    <link rel="stylesheet" href="https://theweeklychallenge.org/css/main.css">

    <style>
        #goTopButton {
            display: none;          
            position: fixed;        
            bottom: 20px;           
            right: 30px;            
            z-index: 99;            
            border: none;           
            outline: none;          
            background-color: red;  
            color: white;           
            cursor: pointer;        
            padding: 15px;          
            border-radius: 10px;    
            font-size: 18px;        
        }

        #goTopButton:hover {
              background-color: #555;
        }

        
        .toggle-links {
            margin: 15px 0;
            padding-left: 15px;
        }
        .toggle-links a {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            background-color: #4285f4;
            color: white !important;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .toggle-links a:hover {
            background-color: #3367d6;
        }
        .arrow-icon {
            margin-left: 8px;
            font-size: 1.1em;
        }

    </style>


</head>

<body>

<button onclick="goTop()" id="goTopButton" title="Go to top">Top</button>

<script>

    topButton = document.getElementById("goTopButton");

    
    window.onscroll = function() { scrollFunction() };

    function scrollFunction() {
        if (document.body.scrollTop > 40 || document.documentElement.scrollTop > 40) {
            topButton.style.display = "block";
        } else {
            topButton.style.display = "none";
        }
    }

    
    function goTop() {
        document.body.scrollTop = 0; 
        document.documentElement.scrollTop = 0; 
    }

    
    document.addEventListener('DOMContentLoaded', function() {
        
        const showMoreLinkGC = document.querySelector('.show-more-gc');
        const showLessLinkGC = document.querySelector('.show-less-gc');
        const hiddenLinksGC = document.querySelectorAll('.hidden-link-gc');

        if (showMoreLinkGC) {
            showMoreLinkGC.addEventListener('click', function(e) {
                e.preventDefault();
                hiddenLinksGC.forEach(link  => {
                    link.style.display = 'list-item';
                });
                showMoreLinkGC.style.display = 'none';
                showLessLinkGC.style.display = 'inline-flex';
            });
        }

        if (showLessLinkGC) {
            showLessLinkGC.addEventListener('click', function(e) {
                e.preventDefault();
                hiddenLinksGC.forEach(link  => {
                    link.style.display = 'none';
                });
                showLessLinkGC.style.display = 'none';
                showMoreLinkGC.style.display = 'inline-flex';
            });
        }

        
        const showMoreLinkPWC = document.querySelector('.show-more-pwc');
        const showLessLinkPWC = document.querySelector('.show-less-pwc');
        const hiddenLinksPWC = document.querySelectorAll('.hidden-link-pwc');

        if (showMoreLinkPWC) {
            showMoreLinkPWC.addEventListener('click', function(e) {
                e.preventDefault();
                hiddenLinksPWC.forEach(link  => {
                    link.style.display = 'list-item';
                });
                showMoreLinkPWC.style.display = 'none';
                showLessLinkPWC.style.display = 'inline-flex';
            });
        }

        if (showLessLinkPWC) {
            showLessLinkPWC.addEventListener('click', function(e) {
                e.preventDefault();
                hiddenLinksPWC.forEach(link  => {
                    link.style.display = 'none';
                });
                showLessLinkPWC.style.display = 'none';
                showMoreLinkPWC.style.display = 'inline-flex';
            });
        }
    });

</script>

<section class="top-bar animated-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <nav class="navbar navbar-expand-lg navbar-light bg-light">
                    <a class="navbar-brand" href="https://theweeklychallenge.org/">
                        <img src="https://theweeklychallenge.org/images/logo.svg" alt="logo">
                    </a>

                    <button class="navbar-toggler d-lg-none"
                            type="button"
                            data-toggle="collapse"
                            data-target="#navigation"
                            aria-controls="navigation"
                            aria-expanded="false"
                            aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <div class="navbar-collapse" id="navigation">
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="https://theweeklychallenge.org/">Home</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://theweeklychallenge.org/about">About</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://theweeklychallenge.org/chart">Chart</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://theweeklychallenge.org/champions">Champions</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://theweeklychallenge.org/team">Team</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://theweeklychallenge.org/challenges">Challenges</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://theweeklychallenge.org/p5-reviews">Perl/Review</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://theweeklychallenge.org/p6-reviews">Raku/Review</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://theweeklychallenge.org/recaps">Recaps</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://theweeklychallenge.org/blogs">Blogs</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://theweeklychallenge.org/faq">FAQ</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://theweeklychallenge.org/contact">Contact</a>
                            </li>
                            
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
    </div>
</section>


<section class="global-page-header">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="block">
                    <h2>Yara Malware Scanner</h2>
                    <div class="portfolio-meta">
                        <span>Tuesday, Oct 28, 2025</span>|
                        <span> Tags:
                            perl, yara
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="single-post">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                
                <div style="text-align: center" class="post-img">
                    <img class="img-fluid" alt="" src="https://theweeklychallenge.org/images/blog/yara-malware-scanner.jpg">
                </div>
                
                <div style="text-align: justify" class="post-content">
                    <h4 id="disclaimer-image-is-generated-using-chatgpt"><strong>DISCLAIMER:</strong> Image is generated using <code>ChatGPT</code>.</h4>
<br>
<h3 id="nbsp1-introductionintroduction"><a href="#introduction"> 1. Introduction</a></h3>
<h3 id="nbsp2-what-is-yaraffiwhat-is-yaraffi"><a href="#what-is-yaraffi"> 2. What is YaraFFI?</a></h3>
<h3 id="nbsp3-install-yara-and-yaraffiinstall-yara-and-yaraffi"><a href="#install-yara-and-yaraffi"> 3. Install YARA and YaraFFI</a></h3>
<h3 id="nbsp4-basic-usagebasic-usage"><a href="#basic-usage"> 4. Basic Usage</a></h3>
<h3 id="nbsp5-writing-simple-yara-rulewriting-simple-yara-rule"><a href="#writing-simple-yara-rule"> 5. Writing Simple YARA Rule</a></h3>
<h3 id="nbsp6-scanning-memory-bufferscanning-memory-buffer"><a href="#scanning-memory-buffer"> 6. Scanning Memory Buffer</a></h3>
<h3 id="nbsp7-scanning-filescanning-file"><a href="#scanning-file"> 7. Scanning File</a></h3>
<h3 id="nbsp8-callback-eventscallback-events"><a href="#callback-events"> 8. Callback Events</a></h3>
<h3 id="nbsp9-limitationslimitations"><a href="#limitations"> 9. Limitations</a></h3>
<h3 id="10-exampleexample"><a href="#example">10. Example</a></h3>
<br>
<h2 id="introduction">Introduction</h2>
<hr>
<br>
<p>YARA is a battle‑tested malware pattern matching engine relied on by reverse engineers, DFIR analysts and modern SOC pipelines. It lets you express malware characteristics in readable rules and scan files or memory for matches. YaraFFI brings this capability natively into Perl — no system calls, no temporary files — by binding directly to the C library via FFI::Platypus.</p>
<br>
<h2 id="what-is-yaraffi">What is YaraFFI?</h2>
<hr>
<p>YaraFFI is a minimal, modern Perl interface to the libyara C engine using FFI (Foreign Function Interface). Instead of relying on XS or spawning the yara CLI tool, it talks to YARA in‑process. This makes it ideal for embedding in automation, stream scanners, build pipelines and malware research scripts. Explain module purpose.</p>
<br>
<h2 id="installing-yara-and-yaraffi">Installing YARA and YaraFFI</h2>
<hr>
<p>You need the native <code>libyara</code> shared library installed first.</p>
<br>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo apt install libyara-dev yara
</code></pre></div><br>
<p>Then install the <code>Perl</code> module from <code>CPAN</code>:</p>
<br>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cpanm -vS YaraFFI
</code></pre></div><br>
<h2 id="basic-usage">Basic Usage</h2>
<hr>
<p>Let’s start with a minimal real scan.</p>
<br>
<h3 id="file-ex-1pl">File: <code>ex-1.pl</code></h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">use</span> YaraFFI;

<span style="color:#66d9ef">my</span> $rules <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;&lt;&#39;</span><span style="color:#e6db74">YARA</span><span style="color:#e6db74">&#39;;
</span><span style="color:#e6db74">rule HelloWorld {
</span><span style="color:#e6db74">  strings:
</span><span style="color:#e6db74">    $a = &#34;hello&#34; ascii
</span><span style="color:#e6db74">  condition:
</span><span style="color:#e6db74">    $a
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74"></span><span style="color:#e6db74">YARA</span>

<span style="color:#66d9ef">my</span> $yara <span style="color:#f92672">=</span> YaraFFI<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>;
$yara<span style="color:#f92672">-&gt;</span>compile($rules) <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;compile failed&#34;</span>;

$yara<span style="color:#f92672">-&gt;</span>scan_buffer(<span style="color:#e6db74">&#34;hello hacker&#34;</span>, <span style="color:#66d9ef">sub</span> {
    <span style="color:#66d9ef">my</span> ($event) <span style="color:#f92672">=</span> @_;
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Matched event: $event\n&#34;</span>;
}, emit_string_events <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0</span>);
</code></pre></div><br>
<h3 id="output">Output</h3>
<br>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ perl ex-1.pl
Matched rule: HelloWorld
</code></pre></div><br>
<h2 id="writing-simple-yara-rule">Writing Simple YARA Rule</h2>
<hr>
<p>In YARA a rule is divided into meta, strings and condition sections. For a practical first example we’ll detect the ASCII word test.</p>
<br>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">my</span> $rules <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;&lt;&#39;</span><span style="color:#e6db74">YARA</span><span style="color:#e6db74">&#39;;
</span><span style="color:#e6db74">rule TestRule {
</span><span style="color:#e6db74">  meta:
</span><span style="color:#e6db74">    description = &#34;Detect the literal string &#39;test&#39;&#34;
</span><span style="color:#e6db74">    author = &#34;you@example.com&#34;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  strings:
</span><span style="color:#e6db74">    $t1 = &#34;test&#34; ascii
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  condition:
</span><span style="color:#e6db74">    $t1
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74"></span><span style="color:#e6db74">YARA</span>
</code></pre></div><br>
<h2 id="scanning-memory-buffer">Scanning Memory Buffer</h2>
<hr>
<p><code>scan_buffer</code> is the most common in-process operation, it lets you scan arbitrary byte buffers (scalars) directly. This is ideal for scanning network captures, unpacked payloads, or API-returned blobs without touching disk.</p>
<br>
<h3 id="file-ex-2pl">File: <code>ex-2.pl</code></h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">use</span> YaraFFI;

<span style="color:#66d9ef">my</span> $rules <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;&lt;&#39;</span><span style="color:#e6db74">YARA</span><span style="color:#e6db74">&#39;;
</span><span style="color:#e6db74">rule TestRule {
</span><span style="color:#e6db74">  meta:
</span><span style="color:#e6db74">    description = &#34;Detect the literal string &#39;test&#39;&#34;
</span><span style="color:#e6db74">    author = &#34;you@example.com&#34;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  strings:
</span><span style="color:#e6db74">    $t1 = &#34;test&#34; ascii
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  condition:
</span><span style="color:#e6db74">    $t1
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74"></span><span style="color:#e6db74">YARA</span>

<span style="color:#66d9ef">my</span> $yara <span style="color:#f92672">=</span> YaraFFI<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>;
$yara<span style="color:#f92672">-&gt;</span>compile($rules) <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;compile failed&#34;</span>;

<span style="color:#66d9ef">my</span> $payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;this is a test payload&#34;</span>;

$y<span style="color:#f92672">-&gt;</span>scan_buffer($payload, <span style="color:#66d9ef">sub</span> {
    <span style="color:#66d9ef">my</span> ($event) <span style="color:#f92672">=</span> @_;
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Matched: $event\n&#34;</span>;
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Event type: &#34;</span> <span style="color:#f92672">.</span> $event<span style="color:#f92672">-&gt;</span>{event}, <span style="color:#e6db74">&#34;\n&#34;</span>;
});
</code></pre></div><br>
<h3 id="output-1">Output</h3>
<br>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ perl ex-2.pl
Matched: TestRule
Event type: rule_match
Matched: TestRule
Event type: string_match
</code></pre></div><br>
<p>Important practical notes:</p>
<br>
<ul>
<li>
<p>Binary data &amp; binmode:</p>
<p>Ensure any data read from files or sockets is treated as raw bytes (Perl&rsquo;s <code>binmode</code> or <code>read_file(..., binmode =&gt; ':raw')</code>). <code>scan_buffer</code> expects a <code>Perl</code> scalar containing the bytes to scan.</p>
</li>
<li>
<p>Large buffers:</p>
<p>Scanning very large buffers in one call consumes memory and may be slow. For very large inputs consider chunking and scanning each chunk with <code>scan_buffer</code>. Because <code>YaraFFI</code> (currently) does not report match offsets, if you need exact byte positions you must track chunk offsets yourself and be prepared for edge cases near chunk boundaries.</p>
</li>
<li>
<p>Callback behaviour:</p>
<p>The callback is invoked for <code>rule_match</code> and <code>string_match</code> events. The supplied event object stringifies to the <code>rule name</code> but also contains a hash-like structure e.g. <code>{ event =&gt; 'rule_match', rule =&gt; 'RuleName' }</code>.</p>
</li>
<li>
<p>Concurrency:</p>
<p><code>FFI::Platypus</code> closures capture <code>Perl</code> state; concurrency models vary — prefer process-level parallelism for heavy scanning workloads until you’ve tested threads in your environment.</p>
</li>
</ul>
<br>
<h3 id="collecting-matches-into-an-array">Collecting matches into an array:</h3>
<br>
<h3 id="file-ex-3pl">File: <code>ex-3.pl</code></h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">use</span> YaraFFI;

<span style="color:#66d9ef">my</span> $rules <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;&lt;&#39;</span><span style="color:#e6db74">YARA</span><span style="color:#e6db74">&#39;;
</span><span style="color:#e6db74">rule TestRule {
</span><span style="color:#e6db74">  meta:
</span><span style="color:#e6db74">    description = &#34;Detect the literal string &#39;test&#39;&#34;
</span><span style="color:#e6db74">    author = &#34;you@example.com&#34;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  strings:
</span><span style="color:#e6db74">    $t1 = &#34;test&#34; ascii
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  condition:
</span><span style="color:#e6db74">    $t1
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74"></span><span style="color:#e6db74">YARA</span>

<span style="color:#66d9ef">my</span> $yara <span style="color:#f92672">=</span> YaraFFI<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>;
$yara<span style="color:#f92672">-&gt;</span>compile($rules) <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;compile failed&#34;</span>;

<span style="color:#66d9ef">my</span> $payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;this is a test payload&#34;</span>;

<span style="color:#66d9ef">my</span> @hits;
$yara<span style="color:#f92672">-&gt;</span>scan_buffer($payload, <span style="color:#66d9ef">sub</span> {
    <span style="color:#66d9ef">my</span> ($event) <span style="color:#f92672">=</span> @_;
    push @hits, $event;
});

<span style="color:#66d9ef">print</span> scalar(@hits) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34; matches found.\n&#34;</span>;
<span style="color:#66d9ef">foreach</span> <span style="color:#66d9ef">my</span> $e (@hits) {
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;- &#34;</span> <span style="color:#f92672">.</span> $e<span style="color:#f92672">-&gt;</span>{rule} <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34; (&#34;</span> <span style="color:#f92672">.</span> $e<span style="color:#f92672">-&gt;</span>{event} <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;)\n&#34;</span>;
}
</code></pre></div><br>
<h3 id="output-2">Output</h3>
<br>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ perl ex-3.pl
<span style="color:#ae81ff">2</span> matches found
- TestRule <span style="color:#f92672">(</span>rule_match<span style="color:#f92672">)</span>
- TestRule <span style="color:#f92672">(</span>string_match<span style="color:#f92672">)</span>
</code></pre></div><br>
<h2 id="scanning-file">Scanning File</h2>
<hr>
<p><code>scan_file</code> in <code>YaraFFI</code> is a convenience wrapper that reads the file into memory and calls <code>scan_buffer</code>. For small-to-medium files this is usually the easiest option.</p>
<br>
<h3 id="file-ex-4pl">File: <code>ex-4.pl</code></h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">use</span> YaraFFI;

<span style="color:#66d9ef">my</span> $rules <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;&lt;&#39;</span><span style="color:#e6db74">YARA</span><span style="color:#e6db74">&#39;;
</span><span style="color:#e6db74">rule TestRule {
</span><span style="color:#e6db74">  meta:
</span><span style="color:#e6db74">    description = &#34;Detect the literal string &#39;test&#39;&#34;
</span><span style="color:#e6db74">    author = &#34;you@example.com&#34;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  strings:
</span><span style="color:#e6db74">    $t1 = &#34;test&#34; ascii
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  condition:
</span><span style="color:#e6db74">    $t1
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74"></span><span style="color:#e6db74">YARA</span>

<span style="color:#66d9ef">my</span> $yara <span style="color:#f92672">=</span> YaraFFI<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>;
$yara<span style="color:#f92672">-&gt;</span>compile($rules) <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;compile failed&#34;</span>;

$yara<span style="color:#f92672">-&gt;</span>scan_file($ARGV[<span style="color:#ae81ff">0</span>], <span style="color:#66d9ef">sub</span> {
    <span style="color:#66d9ef">my</span> ($event) <span style="color:#f92672">=</span> @_;
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;[event=$event-&gt;{event}] rule=$event-&gt;{rule}\n&#34;</span>;
});
</code></pre></div><br>
<p>Let&rsquo;s first create a malicious file, <code>malicious.bin</code>, for the demo purpose.</p>
<br>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>/dev/urandom of<span style="color:#f92672">=</span>random.bin bs<span style="color:#f92672">=</span>1K count<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> 2&gt;/dev/null
$ printf <span style="color:#e6db74">&#39;test&#39;</span> | dd of<span style="color:#f92672">=</span>random.bin bs<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> seek<span style="color:#f92672">=</span><span style="color:#ae81ff">16384</span> conv<span style="color:#f92672">=</span>notrunc 2&gt;/dev/null
$ mv random.bin malicious.bin
</code></pre></div><br>
<h3 id="output-3">Output</h3>
<br>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ perl ex-4.pl malicious.bin
<span style="color:#f92672">[</span>event<span style="color:#f92672">=</span>rule_match<span style="color:#f92672">]</span> rule<span style="color:#f92672">=</span>TestRule
<span style="color:#f92672">[</span>event<span style="color:#f92672">=</span>string_match<span style="color:#f92672">]</span> rule<span style="color:#f92672">=</span>TestRule
</code></pre></div><br>
<h3 id="practical-considerations">Practical considerations:</h3>
<br>
<ul>
<li>
<p>Large files: <code>scan_file</code> slurps the whole file. For very large files read the file in chunks and call <code>scan_buffer</code> per chunk while tracking chunk offsets externally.</p>
</li>
<li>
<p>Binary mode: <code>scan_file</code> uses binary read (<code>:raw</code>). If you implement your own reader, always open files with <code>binmode</code> on Windows to avoid <code>CRLF</code> conversions.</p>
</li>
<li>
<p>Directory scanning: To scan many files, use File::Find or Path::Tiny to iterate and call scan_file for each regular file.</p>
</li>
</ul>
<br>
<h3 id="chunked-scanning-pattern">Chunked scanning pattern:</h3>
<br>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">use</span> YaraFFI;

die <span style="color:#e6db74">&#34;Usage: $0 &lt;file&gt;\n&#34;</span> <span style="color:#66d9ef">unless</span> @ARGV <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>;
<span style="color:#66d9ef">my</span> $path <span style="color:#f92672">=</span> $ARGV[<span style="color:#ae81ff">0</span>];

<span style="color:#66d9ef">my</span> $rules <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;&lt;&#39;</span><span style="color:#e6db74">YARA</span><span style="color:#e6db74">&#39;;
</span><span style="color:#e6db74">rule TestRule {
</span><span style="color:#e6db74">  meta:
</span><span style="color:#e6db74">    description = &#34;Detect the literal string &#39;test&#39;&#34;
</span><span style="color:#e6db74">    author = &#34;you@example.com&#34;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  strings:
</span><span style="color:#e6db74">    $t1 = &#34;test&#34; ascii
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  condition:
</span><span style="color:#e6db74">    $t1
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74"></span><span style="color:#e6db74">YARA</span>

<span style="color:#66d9ef">my</span> $yara <span style="color:#f92672">=</span> YaraFFI<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>;
$yara<span style="color:#f92672">-&gt;</span>compile($rules) <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;compile failed&#34;</span>;

open <span style="color:#66d9ef">my</span> $fh, <span style="color:#e6db74">&#39;&lt;:raw&#39;</span>, $path <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;open $path: $!&#34;</span>;

<span style="color:#66d9ef">my</span> $chunk_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span>;
<span style="color:#66d9ef">my</span> $offset     <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">my</span> $overlap    <span style="color:#f92672">=</span> <span style="color:#ae81ff">4096</span>;
<span style="color:#66d9ef">my</span> $carry      <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;

<span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
    <span style="color:#66d9ef">my</span> $buf;
    <span style="color:#66d9ef">my</span> $read <span style="color:#f92672">=</span> read($fh, $buf, $chunk_size);
    <span style="color:#66d9ef">last</span> <span style="color:#66d9ef">unless</span> $read;

    <span style="color:#66d9ef">my</span> $to_scan <span style="color:#f92672">=</span> $carry <span style="color:#f92672">.</span> $buf;
    <span style="color:#66d9ef">my</span> $chunk_start <span style="color:#f92672">=</span> $offset <span style="color:#f92672">-</span> length($carry);  <span style="color:#75715e"># Account for overlap</span>

    $y<span style="color:#f92672">-&gt;</span>scan_buffer($to_scan, <span style="color:#66d9ef">sub</span> {
        <span style="color:#66d9ef">my</span> ($event) <span style="color:#f92672">=</span> @_;
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;[event=$event-&gt;{event}] rule=$event-&gt;{rule} (chunk start: $chunk_start)\n&#34;</span>;
    }, emit_string_events <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">1</span>);

    <span style="color:#66d9ef">if</span> (length($to_scan) <span style="color:#f92672">&gt;</span> $overlap) {
        $carry <span style="color:#f92672">=</span> substr($to_scan, <span style="color:#f92672">-</span>$overlap);
    } <span style="color:#66d9ef">else</span> {
        $carry <span style="color:#f92672">=</span> $to_scan;
    }

    $offset <span style="color:#f92672">+=</span> $read;
}

close $fh;
</code></pre></div><br>
<h3 id="output-4">Output</h3>
<br>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ perl ex-5.pl malicious.bin
<span style="color:#f92672">[</span>event<span style="color:#f92672">=</span>rule_match<span style="color:#f92672">]</span> rule<span style="color:#f92672">=</span>TestRule <span style="color:#f92672">(</span>chunk start: 12288<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>event<span style="color:#f92672">=</span>string_match<span style="color:#f92672">]</span> rule<span style="color:#f92672">=</span>TestRule <span style="color:#f92672">(</span>chunk start: 12288<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>event<span style="color:#f92672">=</span>rule_match<span style="color:#f92672">]</span> rule<span style="color:#f92672">=</span>TestRule <span style="color:#f92672">(</span>chunk start: 13312<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>event<span style="color:#f92672">=</span>string_match<span style="color:#f92672">]</span> rule<span style="color:#f92672">=</span>TestRule <span style="color:#f92672">(</span>chunk start: 13312<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>event<span style="color:#f92672">=</span>rule_match<span style="color:#f92672">]</span> rule<span style="color:#f92672">=</span>TestRule <span style="color:#f92672">(</span>chunk start: 14336<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>event<span style="color:#f92672">=</span>string_match<span style="color:#f92672">]</span> rule<span style="color:#f92672">=</span>TestRule <span style="color:#f92672">(</span>chunk start: 14336<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>event<span style="color:#f92672">=</span>rule_match<span style="color:#f92672">]</span> rule<span style="color:#f92672">=</span>TestRule <span style="color:#f92672">(</span>chunk start: 15360<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>event<span style="color:#f92672">=</span>string_match<span style="color:#f92672">]</span> rule<span style="color:#f92672">=</span>TestRule <span style="color:#f92672">(</span>chunk start: 15360<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>event<span style="color:#f92672">=</span>rule_match<span style="color:#f92672">]</span> rule<span style="color:#f92672">=</span>TestRule <span style="color:#f92672">(</span>chunk start: 16384<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>event<span style="color:#f92672">=</span>string_match<span style="color:#f92672">]</span> rule<span style="color:#f92672">=</span>TestRule <span style="color:#f92672">(</span>chunk start: 16384<span style="color:#f92672">)</span>
</code></pre></div><br>
<h2 id="callback-events">Callback Events</h2>
<hr>
<p><code>YaraFFI</code> exposes matches to your <code>Perl</code> code via a small, friendly event object (the <code>YaraFFI::Event</code> class). The object is blessed but intentionally minimal, it stringifies to the rule name so simple test scripts can say <code>$event</code> and get a readable output. It also behaves like a <code>hashref</code> for more detailed inspection in tests or tooling.</p>
<p>Typical events you&rsquo;ll observe with this minimal binding:</p>
<ul>
<li>
<p><code>rule_match</code>: indicates a rule matched. The object has at least { event =&gt; &lsquo;rule_match&rsquo;, rule =&gt; &lsquo;RuleName&rsquo; }.</p>
</li>
<li>
<p><code>string_match</code>: a lightweight stand-in for when a string inside a rule matched; it carries { event =&gt; &lsquo;string_match&rsquo;, rule =&gt; &lsquo;RuleName&rsquo;, string_id =&gt; &lsquo;$&hellip;&rsquo; }.</p>
</li>
</ul>
<br>
<p>The goal of <code>YaraFFI</code> is simplicity and predictability. Instead of exposing the full complex <code>YR_RULE</code> struct and offsets (which differ across <code>libyara</code> versions), <code>YaraFFI</code> maps the most useful information into a stable <code>Perl</code> object you can inspect or stringify.</p>
<br>
<h2 id="limitations">Limitations</h2>
<hr>
<p>This module is intentionally minimal. That keeps the <code>API</code> stable and easy to understand but it also means a number of features are not present yet. Be aware of these before you build on <code>YaraFFI</code>:</p>
<ul>
<li>
<p>No match offsets or metadata - you cannot yet determine the exact byte offset within a buffer where the match happened, nor retrieve rule metadata fields.</p>
</li>
<li>
<p>No modules / external variables - <code>YARA</code> modules (e.g. <code>PE</code>, <code>ELF</code>) and providing external variables to rules are not implemented.</p>
</li>
<li>
<p>No finished or import events — only <code>rule_match</code> and <code>string_match</code> events are surfaced.</p>
</li>
<li>
<p>Assumes <code>libyara</code> ABI compatibility — the callback currently probes the <code>YR_RULE</code> structure at runtime to find the identifier pointer. This is fragile across very old/new <code>YARA</code> versions; test with your target <code>libyara</code> version.</p>
</li>
<li>
<p>Scan flags hardcoded to <code>0</code> — no mechanism exposed yet to change <code>YARA</code> scan flags (e.g., <code>SCAN_FLAGS_PROCESS_MEMORY</code> in some deployments).</p>
</li>
</ul>
<br>
<h3 id="why-this-design-matters">Why This Design Matters?</h3>
<br>
<p>Embedding <code>YARA</code> with <code>FFI</code> is about speed and control. Calling the <code>CLI</code> in a subprocess works, but it costs process startup time and complicates embedding in long-running daemons. The small, well-defined surface area of <code>YaraFFI</code> keeps it practical for automation tasks like pre-commit scans, CI checks or evidence triage.</p>
<br>
<h3 id="troubleshooting">Troubleshooting</h3>
<br>
<ul>
<li>
<p>If <code>yr_initialize()</code> fails, ensure <code>libyara</code> is installed and the shared library (<code>libyara.so</code>, <code>libyara.dylib</code>) is on your library path.</p>
</li>
<li>
<p>If compile returns false, double-check your rule syntax with the <code>yara</code> CLI (e.g., yara -s myrules.yar) to rule out syntax errors.</p>
</li>
<li>
<p>On mismatched libyara versions you may see the warning <code>DEBUG: Could not find valid rule name</code> - this is the callback failing to locate the identifier field in the <code>YR_RULE</code> structure.</p>
</li>
</ul>
<br>
<h2 id="example">Example</h2>
<hr>
<h3 id="file-ex-6pl">File: <code>ex-6.pl</code></h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">use</span> YaraFFI;
<span style="color:#66d9ef">use</span> File::Slurp <span style="color:#e6db74">qw(read_file)</span>;

die <span style="color:#e6db74">&#34;Usage: $0 &lt;file&gt;&#34;</span> <span style="color:#66d9ef">unless</span> @ARGV <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>;
<span style="color:#66d9ef">my</span> ($file) <span style="color:#f92672">=</span> @ARGV;

<span style="color:#66d9ef">my</span> $rules <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;&lt;&#39;</span><span style="color:#e6db74">YARA</span><span style="color:#e6db74">&#39;;
</span><span style="color:#e6db74">rule DemoRule {
</span><span style="color:#e6db74">    strings:
</span><span style="color:#e6db74">    $s1 = &#34;test&#34; ascii
</span><span style="color:#e6db74">    condition:
</span><span style="color:#e6db74">    $s1
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74"></span><span style="color:#e6db74">YARA</span>

<span style="color:#66d9ef">my</span> $y <span style="color:#f92672">=</span> YaraFFI<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>;
$y<span style="color:#f92672">-&gt;</span>compile($rules) <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;Failed to compile rules&#34;</span>;

<span style="color:#66d9ef">my</span> $content <span style="color:#f92672">=</span> read_file($file, binmode <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;:raw&#39;</span>);

<span style="color:#66d9ef">my</span> $matches <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
$y<span style="color:#f92672">-&gt;</span>scan_buffer($content, <span style="color:#66d9ef">sub</span> {
    <span style="color:#66d9ef">my</span> ($event) <span style="color:#f92672">=</span> @_;
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Match: $event\n&#34;</span>;
    $matches<span style="color:#f92672">++</span>;
});


<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Total matches: $matches\n&#34;</span>;
</code></pre></div><br>
<h3 id="output-5">Output</h3>
<br>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ perl ex-6.pl malicious.bin
Match: DemoRule
Match: DemoRule
Total matches: <span style="color:#ae81ff">2</span>
</code></pre></div><br>
<p><code>Happy Hacking !!!</code></p>

                </div>
            </div>
        </div>
    </div>
</section>


<!-- Call To Action Section Start -->
<section id="call-to-action">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="block">
                    <h2 class="title wow fadeInDown" data-wow-delay=".3s" data-wow-duration="500ms">SO WHAT DO YOU THINK ?</h2>
                    <p class="wow fadeInDown" data-wow-delay=".5s" data-wow-duration="500ms">If you have any suggestions or ideas then please do share with us.</p>
                    <a href="mailto:mohammad.anwar@yahoo.com" class="btn btn-default btn-contact wow fadeInDown" data-wow-delay=".7s" data-wow-duration="500ms">Contact with me</a>
                </div>
            </div>

        </div>
    </div>
</section>
<!-- Call To Action Section End -->



<!-- Footer Section Start -->
<footer id="footer">
    <div class="container">
        <div class="row content-justify-between">
            <div class="col-md-8 col-12 text-center text-lg-left text-md-left">
                <p class="copyright">Copyright:
                    <span>
                        2019 - 2025
                    </span> The Weekly Challenge. Theme Design and Developed by
                    <a href="http://www.Themefisher.com" rel="noreferrer" rel="noreferrer" target="_blank">Themefisher</a>.
                </p>
            </div>
            <div class="col-md-4 col-12">
                <!-- Social Media -->
                <ul class="social text-center text-md-right text-lg-right">
                    <li>
                        <a href="https://twitter.com/PerlWChallenge" class="twitter" rel="noreferrer" target="_blank" title="Follow us">
                            <i class="ion-social-twitter"></i>
                        </a>
                    </li>
                    <li>
                        <a href="/rss.xml" class="rss" target="_blank" title="RSS Feed">
                            <i class="ion-social-rss"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</footer>
<!-- footer section end -->

<!-- jquery -->
<script src="https://theweeklychallenge.org/plugins/jquery/jquery.min.js"></script>
<!-- Form Validation -->
<script src="https://theweeklychallenge.org/plugins/form-validation/jquery.form.min.js"></script>
<script src="https://theweeklychallenge.org/plugins/form-validation/jquery.validate.min.js"></script>
<!-- slick slider -->
<script src="https://theweeklychallenge.org/plugins/slick/slick.min.js"></script>
<!-- bootstrap js -->
<script src="https://theweeklychallenge.org/plugins/bootstrap/bootstrap.min.js"></script>
<!-- chart js -->
<script src="https://theweeklychallenge.org/plugins/chart/highstock.js"></script>
<script src="https://theweeklychallenge.org/plugins/chart/drilldown.js"></script>
<script src="https://theweeklychallenge.org/plugins/chart/data.js"></script>
<script src="https://theweeklychallenge.org/plugins/chart/chart.js"></script>
<script src="https://theweeklychallenge.org/plugins/chart/pwc-challenge.js"></script>
<script src="https://theweeklychallenge.org/plugins/chart/gc-challenge.js"></script>
<!-- wow js -->
<script src="https://theweeklychallenge.org/plugins/wow-js/wow.min.js"></script>
<!-- slider js -->
<script src="https://theweeklychallenge.org/plugins/slider/slider.js"></script>
<!-- Fancybox -->
<script src="https://theweeklychallenge.org/plugins/facncybox/jquery.fancybox.js"></script>
<!-- template main js -->

<script src="https://theweeklychallenge.org/js/script.min.js"></script>
<!-- google analitycs -->

<script async src="https://www.googletagmanager.com/gtag/js?id=G-CJTPYM9SB8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CJTPYM9SB8');
</script>
</body>

</html>

